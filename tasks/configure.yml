---

- name: Render configuration and settings
  ansible.builtin.set_fact:
    _pdns_rec_config: "{{ default_pdns_rec_config | ansible.builtin.combine(pdns_rec_config, recursive=true) }}"
    _service_overrides: "{{ default_pdns_rec_service_overrides | ansible.builtin.combine(pdns_rec_service_overrides, recursive=true) }}"
    _rec_dirs: "{{ [pdns_rec_config_dir] + pdns_rec_config_additional_dirs }}"

- name: Configure systemd
  when: ansible_service_mgr == "systemd"
  block:
    - name: Ensure the PowerDNS Recursor drop-in unit overrides directory exists (systemd)
      ansible.builtin.file:
        name: /etc/systemd/system/{{ pdns_rec_service_name }}.service.d
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Override the PowerDNS Recursor unit (systemd)
      ansible.builtin.template:
        src: override-service.systemd.conf.j2
        dest: /etc/systemd/system/{{ pdns_rec_service_name }}.service.d/override.conf
        owner: root
        group: root
        mode: "0644"
      when: pdns_rec_service_overrides | length > 0
      notify:
        - reload systemd
        - restart pdns-recursor

- name: Ensure that the PowerDNS Recursor configuration and additional directories exists
  ansible.builtin.file:
    name: "{{ item.path | default(item) }}"
    state: directory
    owner: "{{ item.owner | default(pdns_rec_file_owner) }}"
    group: "{{ item.group | default(pdns_rec_file_group) }}"
    mode: "{{ item.mode | default('0750') }}"
  loop: "{{ _rec_dirs }}"
  notify: restart pdns-recursor

- name: Copy the PowerDNS Recursor additional files
  ansible.builtin.copy:
    content: "{{ item.content | default(omit) }}"
    src: "{{ item.src | default(omit) }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner | default(pdns_rec_file_owner) }}"
    group: "{{ item.group | default(pdns_rec_file_group) }}"
    mode: "{{ item.mode | default('0750') }}"
  loop: "{{ pdns_rec_config_additional_files }}"
  when: pdns_rec_config_additional_files | length > 0
  notify: restart pdns-recursor

- name: Generate the PowerDNS Recursor configuration
  ansible.builtin.template:
    src: recursor.conf.j2
    dest: "{{ pdns_rec_config_dir }}/{{ pdns_rec_config_file }}"
    owner: "{{ pdns_rec_file_owner }}"
    group: "{{ pdns_rec_file_group }}"
    mode: "0640"
  notify: restart pdns-recursor

- name: Validate PowerDNS Recursor configuration
  when: not ansible_check_mode
  become: true
  become_user: "{{ pdns_rec_file_owner }}"
  vars:
    _cfg_name: "{{ ('@' in pdns_rec_service_name) | ternary((pdns_rec_service_name.split('@') | last), '') }}"
  ansible.builtin.command:
    cmd: "/usr/sbin/pdns_recursor --config=check{{ (_cfg_name | length > 0) | ansible.builtin.ternary(' --config-name=' ~ _cfg_name, '') }}"
  changed_when: false
